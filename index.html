ok lets check again our code <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Money Circle ‚Äî Windows Web App (Vanilla JS, No React)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#111823; --panel2:#0f1520; --muted:#9fb0c3; --text:#e6edf3; --brand:#3b82f6;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --ring:0 0 0 2px rgba(59,130,246,.45); --radius:14px;
    }
    html,body{height:100%}
    body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(11,15,20,.8);backdrop-filter:blur(8px);border-bottom:1px solid #1e293b}
    .container{max-width:1200px;margin:0 auto;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:36px;height:36px;border-radius:12px;background:#2563eb;display:grid;place-items:center;box-shadow:0 6px 18px rgba(0,0,0,.4)}
    nav{display:flex;flex-wrap:wrap;gap:8px;margin-left:16px}
    nav button{padding:8px 12px;border-radius:12px;border:1px solid #243142;background:#0b0f14;color:var(--text);cursor:pointer}
    nav button.active{background:#0f172a;border-color:#334155}
    .row{display:flex;gap:12px;align-items:center}
    .grow{flex:1}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid #334155;background:#111823;color:var(--text);cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#2563eb}
    .btn.danger{border-color:#7f1d1d;background:#450a0a;color:#fecaca}
    .btn.ok{background:#065f46;border-color:#065f46}
    input,select,textarea{background:#0f1520;border:1px solid #243142;color:var(--text);border-radius:12px;padding:10px;outline:none}
    input:focus,select:focus,textarea:focus{box-shadow:var(--ring)}
    .card{background:#0f1520;border:1px solid #1f2937;border-radius:16px;padding:14px}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .muted{color:#9fb0c3}
    .small{font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #334155;background:#0b0f14;font-size:12px}
    .hstack{display:flex;gap:8px;align-items:center}
    .avatar{width:56px;height:56px;border-radius:14px;object-fit:cover;border:1px solid #233042;background:#0b0f14}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;text-align:left;border-bottom:1px solid #18202d}
    .notice{position:fixed;top:14px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #253048;border-radius:12px;padding:8px 12px;z-index:60}
    .hidden{display:none !important}
    .right{margin-left:auto}
    .footer{color:#94a3b8;font-size:12px;margin-top:6px}
    .img-s{width:44px;height:44px;border-radius:12px;object-fit:cover;border:1px solid #233042;background:#0b0f14}
    .overflow{max-height:280px;overflow:auto;padding-right:6px}
    .kpi{font-weight:600;font-size:18px;margin-top:4px}
    .tag{font-size:11px;padding:2px 6px;border-radius:8px;border:1px solid #334155;background:#0b0f14}

    /* Donor chips for recipient cards */
.donor-list{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px }
.donor-chip{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #334155; border-radius:999px; background:#0b0f14; font-size:12px }
.donor-chip img{ width:20px; height:20px; border-radius:50%; object-fit:cover; border:1px solid #233042; background:#0b0f14 }

/* Groups manager */
.groupsWrap{ display:grid; gap:12px }
@media (min-width: 900px){ .groupsWrap{ grid-template-columns: repeat(3,minmax(0,1fr)) } }
.groupCol{ background:#0f1520; border:1px solid #1f2937; border-radius:16px; padding:12px; min-height:220px }
.groupHeader{ display:flex; gap:8px; align-items:center; margin-bottom:8px }
.groupHeader input{ flex:1; padding:8px 10px; border-radius:10px }
.memberChip{ display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px dashed #334155; border-radius:12px; margin:6px 0; background:#0b0f14 }
.memberChip.dragging{ opacity:.6 }
.groupCol.dragOver{ outline:2px dashed #3b82f6; outline-offset:4px }
 

/* === Mobile-first fixes (add at the END of your <style>) === */

.shareRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }


/* 1) Grids: default to 1 column on small screens */
.grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }

/* 2) Small ‚â•640px: let some grids go to 2 columns */
@media (min-width: 640px) {
  .grid-2 { grid-template-columns: repeat(2, 1fr); }
  .grid-3 { grid-template-columns: repeat(2, 1fr); }
  .grid-4 { grid-template-columns: repeat(2, 1fr); }
}

/* 3) Desktop ‚â•1024px: restore full layouts */
@media (min-width: 1024px) {
  .grid-3 { grid-template-columns: repeat(3, 1fr); }
  .grid-4 { grid-template-columns: repeat(4, 1fr); }
}

/* 4) Let rows wrap on small screens; keep header tidy */
@media (max-width: 640px) {
  .row { flex-wrap: wrap; }
  header .container { gap: 8px; }
  nav { gap: 6px; overflow-x: auto; }
  .brand .logo { width: 28px; height: 28px; border-radius: 10px; }
  .container { padding: 10px 12px; }
}

/* 5) Inputs/Search: avoid fixed widths on mobile */
@media (max-width: 640px) {
  input, select, textarea { width: 100%; box-sizing: border-box; }

  /* override inline widths */
  #memberSearch,
  #payoutSearch,
  #contribSearch { width: 100% !important; }

  /* PIN can stay smaller */
  #managerPinInput { width: 120px !important; }
}

/* 6) Cards/avatars scale a bit smaller on phones */
@media (max-width: 640px) {
  .avatar { width: 48px; height: 48px; }
  .img-s  { width: 40px; height: 40px; }
}

/* 7) Tables: enable horizontal scroll instead of squishing */
@media (max-width: 640px) {
  table { display: block; overflow-x: auto; white-space: nowrap; }
  th, td { padding: 8px 12px; }
}

/* === Top nav: horizontal pills (mobile-friendly) === */
nav{
  display:flex;
  gap:8px;
  flex-wrap:nowrap;                /* keep in one row */
  overflow-x:auto;                 /* allow side scroll */
  -webkit-overflow-scrolling:touch;
  white-space:nowrap;
  scrollbar-width:none;            /* hide scrollbar (Firefox) */
  margin-left:8px;                 /* tighter on small screens */
  padding-bottom:6px;              /* avoid clipping shadow */
}
nav::-webkit-scrollbar{ display:none } /* hide scrollbar (WebKit) */
nav button{
  flex:0 0 auto;                   /* don‚Äôt stretch */
  white-space:nowrap;              /* keep labels on one line */
}

/* Put nav on its own line on small screens; shrink buttons a bit */
@media (max-width:640px){
  header .container{ gap:8px; }
  .row{ flex-wrap:wrap; }          /* your header can wrap */
  nav{ order:3; width:100%; margin-left:0; }
  nav button{ padding:8px 12px; font-size:13px; }
}

/* Restore your larger layouts on desktop */
@media (min-width:1024px){
  nav{ flex-wrap:wrap; overflow-x:visible; white-space:normal; }
}

nav{ scroll-snap-type:x proximity; }
nav button{ scroll-snap-align:start; }



 </style>

</head>
<body>
<header>
  <div class="container row">
    <div class="brand">
      <div class="logo">üí∏</div>
      <div>
        <div style="font-weight:600">Money Circle</div>
        <div class="small muted">Stokvel ¬∑ R10,000 monthly baseline</div>
      </div>
    </div>
    <nav id="nav" class="row grow"></nav>
    <div class="row">
      <input id="managerPinInput" type="password" placeholder="Manager PIN" style="width:140px" autocomplete="off">
      <button class="btn" id="managerToggle">Manager OFF</button>
      <button class="btn" id="setManagerPin" title="Change PIN">Set</button>
    </div>
  </div>
</header>

<div id="notice" class="notice hidden"></div>

<main class="container" style="padding:16px 16px 26px">
  <!-- OVERVIEW -->
  <section id="view-overview" class="grid">
    <div id="managerControls" class="card hidden"></div>
    <div class="grid grid-4">
      <div class="card"><div class="muted small">Active Members</div><div id="stat-members" class="kpi">0</div></div>
      <div class="card"><div class="muted small">Total Contributions</div><div id="stat-contrib" class="kpi">R0.00</div></div>
      <div class="card"><div class="muted small">Total Loaned Out</div><div id="stat-loaned" class="kpi">R0.00</div></div>
      <div class="card"><div class="muted small">Outstanding</div><div id="stat-outstanding" class="kpi">R0.00</div></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0;font-weight:600">Members who received money (Open)</h3>
        <div class="small muted">Round <span id="roundCycle">1</span> ‚Äî served <span id="roundServed">0</span>/<span id="roundTotal">0</span></div>
      </div>
      <div id="openRecipients" class="grid grid-3"></div>
      <div id="noOpenRecipients" class="muted small">No open payouts yet.</div>
    </div>
  </section>

  <!-- AUDIT LOG -->
<section id="view-audit" class="grid hidden">
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">Audit Log</h3>
      <div class="row">
        <select id="auditFilter">
          <option value="">All actions</option>
          <option>member_add</option>
          <option>member_remove</option>
          <option>contrib_record</option>
          <option>payout_create</option>
          <option>payout_mark_paid</option>
          <option>payout_delete</option>
          <option>round_reset</option>
          <option>autoplay_start</option>
          <option>autoplay_stop</option>
          <option>settings_update</option>
        </select>
        <button class="btn" id="auditCSV">Download CSV</button>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="overflow" style="max-height:60vh">
      <table>
        <thead><tr class="small muted"><th>Time</th><th>Actor</th><th>Action</th><th>Details</th></tr></thead>
        <tbody id="auditRows"></tbody>
      </table>
    </div>
  </div>
</section>


  <!-- MEMBERS -->
  <section id="view-members" class="grid hidden">
    <div class="row">
      <input id="memberSearch" placeholder="Search members..." style="width:280px">
      <div class="grow"></div>
      <button class="btn" id="addMemberBtn" title="Manager required">+ Add Member</button>
    </div>
    <div id="memberList" class="grid grid-3"></div>
    <div id="memberTip" class="muted small">Tip: First time setup ‚Äî add members here. Share each member's unique password for login.</div>
  </section>

  <!-- PAYOUTS / LOANS -->
  <section id="view-payouts" class="grid hidden">
    <div class="row">
      <input id="payoutSearch" placeholder="Search payouts by member name..." style="width:300px">
      <div class="grow"></div>
      <button class="btn" id="randomSelectBtn" title="Manager required">üé≤ Random Select & Lend</button>
    </div>
    <div class="card">
      <div class="row small muted">
        <div class="tag">Fair-rotation: selected members are removed from random selection until everyone has had a turn. Then a new round starts automatically.</div>
      </div>
    </div>
    <div id="payoutList" class="grid grid-3"></div>
    <div id="payoutEmpty" class="muted small">No payouts recorded yet.</div>
  </section>

  <!-- CONTRIBUTIONS -->
  <section id="view-contribs" class="grid hidden">
    <div class="card">
      <div class="grid grid-4" style="align-items:end">
        <label> <div class="small muted">Member</div>
          <select id="contribMember"></select>
        </label>
        <label> <div class="small muted">Amount (ZAR)</div>
          <input id="contribAmount" type="number" min="0" step="0.01">
        </label>
        <label> <div class="small muted">Date</div>
          <input id="contribDate" type="date">
        </label>
        <button class="btn primary" id="recordContrib">Record</button>
      </div>
    </div>
    <div class="row">
      <input id="contribSearch" placeholder="Search contributions by member name..." style="width:300px">
      <div class="muted small" id="contribTotal" style="margin-left:8px"></div>
    </div>
    <div class="card">
      <div class="overflow">
        <table>
          <thead>
            <tr class="muted small"><th>Date</th><th>Member</th><th>Amount</th><th>Note</th></tr>
          </thead>
          <tbody id="contribTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PROFILE / LOGIN -->
  <section id="view-profile" class="grid hidden">
    <div class="grid grid-2">
      <div class="card" id="loginPanel">
        <h3 style="margin:0 0 8px;font-weight:600">Log In</h3>
        <div class="grid">
          <label><div class="small muted">I am</div>
            <select id="loginRole">
              <option value="member">Member</option>
              <option value="manager">Manager</option>
            </select>
          </label>
          <label id="loginPwLabel"><div class="small muted">Password</div>
            <input id="loginPw" type="password" placeholder="Enter your password or PIN">
          </label>
          <button class="btn primary" id="loginBtn">Log In</button>
          <div class="small muted">Accounts are created by the manager. Ask the manager for your password.</div>
        </div>
        <div class="footer">This page also shows who has received money (open payouts) below.</div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px;font-weight:600">Members who received money (Open)</h3>
        <div id="loginRecipients" class="grid grid-2"></div>
        <div id="loginRecipientsEmpty" class="muted small">No open payouts yet.</div>
      </div>
    </div>

    <div id="mePanel" class="card hidden">
      <div class="row">
        <img id="meAvatar" class="avatar">
        <div>
          <div id="meName" style="font-weight:600"></div>
          <div class="small muted">Age <span id="meAge"></span> ¬∑ Joined <span id="meJoined"></span></div>
          <div class="small muted">Your password: <code id="mePw" class="pill"></code> <button class="btn" id="copyPw" style="padding:4px 8px">Copy</button></div>
        </div>
        <div class="grow"></div>
        <button class="btn" id="switchAccount">Switch Account</button>
      </div>
      <div class="grid grid-2" style="margin-top:12px">
        <div class="card">
          <h4 style="margin:0 0 6px">Contributions</h4>
          <div class="small muted">Total paid: <span id="mePaid"></span></div>
          <div class="overflow" id="meContribs"></div>
        </div>
        <div class="card">
          <h4 style="margin:0 0 6px">Money Received</h4>
          <div class="small muted">Total received: <span id="meReceived"></span></div>
          <div class="overflow" id="meLoans"></div>
          <div id="meReminder" class="small" style="color:#fcd34d;margin-top:6px"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- BACKUP / SETTINGS -->
  <section id="view-backup" class="grid hidden">
    <div class="grid grid-2">
      <div class="card">
        <h3 style="margin:0 0 8px;font-weight:600">Export</h3>
        <div class="small">Download all data as JSON. Keep it safe.</div>
        <button class="btn" id="printLogsBtn" style="margin-top:10px">PDF-Logs</button>
        <button class="btn primary" id="exportBtn" style="margin-top:10px">Download Backup</button>
        <button class="btn" id="csvContrib" style="margin-top:10px">Download Contributions CSV</button>
        <button class="btn" id="csvPayouts" style="margin-top:10px">Download Payouts CSV</button>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px;font-weight:600">Import</h3>
        <div class="small">Restore from a previous backup file.</div>
        <input id="importInput" type="file" accept="application/json" style="margin-top:10px">
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;font-weight:600">Settings (Manager)</h3>
      <div class="grid grid-3" style="align-items:end">
        <label><div class="small muted">Default monthly contribution (ZAR)</div>
          <input id="defAmount" type="number" min="0" step="0.01">
        </label>
        <label><div class="small muted">Manager PIN</div>
          <input id="managerEdit" type="password">
        </label>
        <button class="btn" id="saveSettings">Save</button>
      </div>
      <div class="footer">Current manager PIN: <code id="managerDisplay" class="pill"></code></div>
    </div>
  </section>

  <!-- GROUPS MANAGER (Manager only) -->
<section id="view-groups" class="grid hidden">
  <div class="card">
    <h3 style="margin:0 0 8px;font-weight:600">Groups Manager</h3>
    <div class="row" style="align-items:end">
      <label><div class="small muted">Number of groups (K)</div>
        <input id="groupsK" type="number" min="1" value="1" style="width:120px">
      </label>
      <button class="btn" id="groupsResize">Resize & Lock</button>
      <button class="btn" id="groupsRebalance">Rebalance</button>
      <button class="btn" id="groupsUnlock">Unlock</button>
      <div class="pill" id="groupsState">‚Äî</div>
      <div class="small muted">Drag members between groups. Titles are editable.</div>
    </div>
  </div>
  <div id="groupsWrap" class="groupsWrap"></div>
</section>

</main>

<!-- ===== Modals ===== -->
<div id="modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.7);display:grid;place-items:center;z-index:80;padding:12px">
  <div class="card" style="width:min(720px,96vw)" id="modalCard"></div>
</div>

<script>
/***** Utilities *****/
const ZAR = new Intl.NumberFormat('en-ZA',{style:'currency',currency:'ZAR',minimumFractionDigits:2});
const uid = () => Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4);
const todayISO = (d=new Date())=>new Date(d.getTime()-d.getTimezoneOffset()*6e4).toISOString().slice(0,10);
const inDays = (a,b)=> Math.ceil((new Date(b)-new Date(a))/(1000*60*60*24));
const clamp = (n,a,b)=> Math.min(Math.max(n,a),b);
const el = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const show = (node, yes)=> node.classList[yes?'remove':'add']('hidden');
const copy = t => navigator.clipboard?.writeText(t).catch(()=>{});
function readAsDataURL(file){ return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file)}); }
function avatarFromName(name='?'){
  const COLORS=['#60a5fa','#34d399','#f59e0b','#f472b6','#a78bfa','#22d3ee'];
  const initials=(name.trim().split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()).join(''))||'?';
  const color=COLORS[initials.charCodeAt(0)%COLORS.length];
  const svg=encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'><rect width='100%' height='100%' rx='24' fill='${color}'/><text x='50%' y='58%' text-anchor='middle' font-family='Segoe UI,Arial' font-size='54' fill='white'>${initials}</text></svg>`);
  return `data:image/svg+xml,${svg}`;
}
function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])) }

/***** Persistence *****/
const STORAGE_KEY='money-circle-vanilla-v2';
function loadStore(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null') } catch{ return null } }
function saveStore(s){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
  if (window.cloud && window.cloudCanWrite) { window.cloud.save(s); }
}


/***** Default Model *****/
const DEFAULT_CONTRIB_CENTS = 1_000_000; // R10,000
const DEFAULT_MANAGER_PIN = '198520';
function newStore(){
  return {
    meta:{ createdAt:new Date().toISOString(), currency:'ZAR', defaultContributionCents:DEFAULT_CONTRIB_CENTS, managerPin: DEFAULT_MANAGER_PIN,
    groups: { locked:false, k:1, map:{} }, // map: memberId -> groupIndex
    autoPlay:{ enabled:false, startedAt:null, day:1, recipientsPerMonth:1, amountCents: DEFAULT_CONTRIB_CENTS, lastRunDate:null },
    autoPlay:{ enabled:false, startedAt:null, day:1, recipientsPerMonth:1, amountCents: DEFAULT_CONTRIB_CENTS, lastRunDate:null } },
    members:[], // {id, fullName, age, password, photoDataUrl, joinedAt, active}
    contributions:[], // {id, memberId, amountCents, date, note}
    loans:[], // {id, recipientId, amountCents, date, dueDate, fromMembers, status:'open'|'paid', paidBackAt}
    rounds:{ cycle:1, servedIds:[] }, // fair rotation
    session:{ role:null, memberId:null },
    
  };
}

let Store = loadStore() || newStore();

// One-time migration: if they were still using the old default, upgrade it
// One-time migration: if they were still using the old default, upgrade it
const PREV_DEFAULT_PIN = '123456';
if (Store?.meta) {
  if (!Store.meta.managerPin) {
    Store.meta.managerPin = DEFAULT_MANAGER_PIN;
  } else if (Store.meta.managerPin === PREV_DEFAULT_PIN) {
    Store.meta.managerPin = DEFAULT_MANAGER_PIN;
  }

  // üîß NEW: ensure groups object + names
  if (!Store.meta.groups) Store.meta.groups = { locked:false, k:1, map:{}, names:["Group 1"] };
  if (!Array.isArray(Store.meta.groups.names) || Store.meta.groups.names.length !== (Store.meta.groups.k||1)) {
    const k = Math.max(1, Store.meta.groups.k || 1);
    Store.meta.groups.names = Array.from({length:k}, (_,i)=>`Group ${i+1}`);
  }
}
// üîß NEW: audit log
if (!Array.isArray(Store.audit)) Store.audit = [];

saveStore(Store);


function getOverdueLoans(){
  return Store.loans.filter(l => l.status==='open' && new Date(l.dueDate) < new Date());
}

function buildReminderText(l){
  const m = Store.members.find(x=>x.id===l.recipientId);
  const days = Math.abs(inDays(todayISO(), l.dueDate));
  const total = ZAR.format((l.amountCents||0)/100);
  return `Hi ${m?.fullName||'member'}, friendly reminder: your stokvel payout of ${total} received on ${l.date} was due on ${l.dueDate} and is now ${days} day(s) overdue. Please settle at your earliest convenience. Thank you.`;
}

function openRemindersModal(){
  const list = getOverdueLoans();
  const card = el('#modalCard');
  card.innerHTML = `
    <div class='row' style='justify-content:space-between'>
      <h3 style='margin:0'>Overdue Reminders</h3>
      <button class='btn' id='xClose' style='padding:4px 8px'>‚úï</button>
    </div>
    <div class='small muted'>${list.length ? list.length+' overdue payout(s).' : 'No overdue payouts.'}</div>
    <div id='remList' class='grid' style='margin-top:8px'></div>
    <div class='shareRow'>
      <button class='btn' id='copyAll'>Copy All</button>
      <button class='btn' id='downloadTxt'>Download .txt</button>
    </div>
  `;
  show(el('#modal'), true);
  el('#xClose').onclick = ()=> show(el('#modal'), false);

  const wrap = el('#remList'); wrap.innerHTML = '';
  list.forEach(l=>{
    const m = Store.members.find(x=>x.id===l.recipientId);
    const text = buildReminderText(l);
    const item = document.createElement('div');
    item.className = 'card';
    item.innerHTML = `
      <div class='row'>
        <img class='img-s' src='${m?.photoDataUrl || avatarFromName(m?.fullName||"?")}' style='width:40px;height:40px'>
        <div class='grow'>
          <div style='font-weight:600'>${escapeHtml(m?.fullName||'‚Äî')}</div>
          <div class='small muted'>Due ${l.dueDate} ¬∑ Total ${ZAR.format((l.amountCents||0)/100)}</div>
        </div>
        <input placeholder='Phone (optional, 27XXXXXXXXX)' data-phone style='width:160px'>
      </div>
      <textarea class='small' data-msg rows='3' style='width:100%;margin-top:6px'>${escapeHtml(text)}</textarea>
      <div class='shareRow'>
        <button class='btn' data-copy>Copy</button>
        <a class='btn' data-wa target='_blank'>WhatsApp</a>
      </div>
    `;
    const waBtn = item.querySelector('[data-wa]');
    const phoneEl = item.querySelector('[data-phone]');
    const msgEl = item.querySelector('[data-msg]');
    const copyBtn = item.querySelector('[data-copy]');

    function refreshWA(){
      const num = (phoneEl.value||'').replace(/\D/g,'');
      const base = num ? `https://wa.me/${num}?text=` : `https://wa.me/?text=`;
      waBtn.href = base + encodeURIComponent(msgEl.value);
    }
    phoneEl.addEventListener('input', refreshWA);
    msgEl.addEventListener('input', refreshWA);
    refreshWA();

    copyBtn.onclick = ()=> navigator.clipboard?.writeText(msgEl.value).then(()=>flash('Copied')).catch(()=>{});
    wrap.appendChild(item);
  });

  el('#copyAll').onclick = ()=>{
    const all = Array.from(wrap.querySelectorAll('[data-msg]')).map(t=>t.value).join('\n\n---\n\n');
    navigator.clipboard?.writeText(all).then(()=>flash('All copied')).catch(()=>{});
  };
  el('#downloadTxt').onclick = ()=>{
    const all = Array.from(wrap.querySelectorAll('[data-msg]')).map(t=>t.value).join('\n\n---\n\n');
    const blob = new Blob([all], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `overdue-reminders-${todayISO()}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
  };
}

// Add a button to Manager Controls without touching your big template strings
function addReminderUI(){
  const mc = el('#managerControls'); if (!mc || !isManager()) return;
  if (mc.querySelector('#overdueBtn')) return;
  let row = mc.querySelector(".row[style*='margin-top']") || mc.querySelector('.row:last-of-type');
  if (!row) { row = document.createElement('div'); row.className = 'row'; row.style.marginTop='8px'; mc.appendChild(row); }
  const btn = document.createElement('button');
  btn.id='overdueBtn'; btn.className='btn'; btn.textContent='üì£ Overdue Reminders';
  btn.onclick = openRemindersModal;
  row.appendChild(btn);
}

function log(action, meta={}){
  const entry = { id: uid(), ts: new Date().toISOString(), actor: isManager() ? 'manager' : (isMember() ? 'member' : 'system'), action, meta };
  Store.audit = [entry, ...(Store.audit||[])].slice(0, 5000); // cap
  saveStore(Store);
}

function renderAudit(){
  const tbody = el('#auditRows'); if(!tbody) return;
  const filt = el('#auditFilter')?.value || '';
  const items = (Store.audit||[]).filter(a => !filt || a.action === filt);
  tbody.innerHTML = '';
  items.forEach(a=>{
    const metaStr = JSON.stringify(a.meta||{}, null, 0);
    tbody.insertAdjacentHTML('beforeend', `
      <tr><td class="small">${a.ts.replace('T',' ').slice(0,19)}</td><td>${a.actor}</td><td>${a.action}</td><td class="small">${escapeHtml(metaStr)}</td></tr>
    `);
  });
  el('#auditFilter')?.addEventListener('change', renderAudit);
  el('#auditCSV')?.addEventListener('click', ()=>{
    const rows = (Store.audit||[]).map(a=>({ts:a.ts, actor:a.actor, action:a.action, meta: JSON.stringify(a.meta||{})}));
    downloadCSV(`audit-${todayISO()}.csv`, ['ts','actor','action','meta'], rows);
  });
}


/***** Session helpers *****/
function setSession(role, memberId=null){ Store.session={role, memberId}; saveStore(Store); renderAll() }
function isManager(){ return Store.session.role==='manager' }
function isMember(){ return Store.session.role==='member' }

function markAllOpenLoansPaid(){
  const open = Store.loans.filter(l => l.status === 'open');
  if (!open.length) { flash('No open loans'); return; }
  const today = todayISO();
  Store.loans = Store.loans.map(l =>
    l.status === 'open' ? { ...l, status: 'paid', paidBackAt: today } : l
  );
  saveStore(Store);
  flash(`Closed ${open.length} open loan(s). Outstanding ‚Üí 0`);
  renderOverview(); renderPayouts(); renderProfile();
}



function clearAllLoansConfirm(){
  if (!isManager()) return alert('Manager login required');
  const total = Store.loans.length;
  if (!total) return flash('No loan history to clear');

  const ok = confirm(
    `Reset Loan History?\n\n` +
    `This will delete ALL payouts/loans (${total}).\n` +
    `‚Ä¢ "Total Loaned Out" will go to 0\n` +
    `‚Ä¢ "Outstanding" will go to 0\n` +
    `‚Ä¢ Members & contributions stay intact\n\n` +
    `Proceed?`
  );
  if (!ok) return;

  Store.loans = [];
  saveStore(Store);
  flash('Loan history cleared');
  renderOverview(); renderPayouts(); renderProfile();
}


function softResetRound(){
  // Only resets the rotation; keeps all history and members
  Store.rounds.cycle += 1;
  Store.rounds.servedIds = [];
  saveStore(Store);
  log('round_reset', { cycle: Store.rounds.cycle });
  flash('New round started (history kept)');
  renderOverview(); renderPayouts(); renderContribs(); renderProfile();
}

function addLoanResetUI(){
  const mc = el('#managerControls');
  if (!mc || !isManager()) return;

  // avoid duplicates on re-render
  if (mc.querySelector('#zeroOutstandingBtn')) return;

  // try to place alongside your existing action row; otherwise create one
  let row = mc.querySelector(".row[style*='margin-top']") || mc.querySelector('.row:last-of-type');
  if (!row) {
    row = document.createElement('div');
    row.className = 'row';
    row.style.marginTop = '8px';
    mc.appendChild(row);
  }

  // Button 1: set Outstanding ‚Üí 0 by marking all open loans as paid
  const zeroBtn = document.createElement('button');
  zeroBtn.className = 'btn';
  zeroBtn.id = 'zeroOutstandingBtn';
  zeroBtn.textContent = '‚úì Mark All Paid (Outstanding ‚Üí 0)';
  zeroBtn.onclick = () => {
    if (!isManager()) return alert('Manager login required');
    const ok = confirm('Mark ALL open payouts as PAID now? Outstanding will become 0.');
    if (ok) markAllOpenLoansPaid();
  };
  row.appendChild(zeroBtn);

  // Button 2: wipe the entire loan history (Total Loaned Out ‚Üí 0)
  const clearBtn = document.createElement('button');
  clearBtn.className = 'btn danger';
  clearBtn.id = 'clearLoanHistoryBtn';
  clearBtn.textContent = 'üóë Reset Loan History (Total Loaned Out ‚Üí 0)';
  clearBtn.onclick = clearAllLoansConfirm;
  row.appendChild(clearBtn);
}


function addResetUI(){
  const mc = el('#managerControls');
  if (!mc || !isManager()) return;

  // avoid duplicates
  if (mc.querySelector('#resetRoundBtn')) return;

  // try to place it on the same row as your action buttons
  let row = mc.querySelector(".row[style*='margin-top']") || mc.querySelector('.row:last-of-type');
  if (!row) {
    // fallback: create a row at the bottom
    row = document.createElement('div');
    row.className = 'row';
    row.style.marginTop = '8px';
    mc.appendChild(row);
  }

  const btn = document.createElement('button');
  btn.className = 'btn';
  btn.id = 'resetRoundBtn';
  btn.textContent = '‚ôª Start New Round';

  // insert before a Stop button if present, else append
  const stop = mc.querySelector('#stopAuto');
  if (stop && stop.parentElement === row) {
    row.insertBefore(btn, stop);
  } else {
    row.appendChild(btn);
  }
  btn.onclick = openResetRoundModal;
}


function openResetRoundModal(){
  if (!isManager()) return alert('Manager login required');
  const total  = Store.members.filter(m=>m.active!==false).length;
  const served = Store.rounds.servedIds.length;
  const ok = confirm(
    `Start a new round?\n\nCurrent round: ${Store.rounds.cycle}\nServed: ${served}/${total}\n\n` +
    `This keeps all payouts & contributions but clears the rotation so everyone is eligible again.`
  );
  if (ok) softResetRound();
}



/***** Notice *****/
let noticeTimer=null; function flash(msg){ const n=el('#notice'); n.textContent=msg; show(n,true); clearTimeout(noticeTimer); noticeTimer=setTimeout(()=>show(n,false),2200) }

/***** Nav + header *****/
const TABS = [
  ['overview','Overview'],
  ['groups','Groups'],         
  ['members','Members'],
  ['payouts','Payouts'],
  ['contribs','Contributions'],
  ['profile','Login / Profile'],
  ['backup','Backup'],
  ['audit','Audit']            
];

function renderNav(){ const nav=el('#nav'); nav.innerHTML='';
  const baseTabs = isManager()? TABS : [['overview','Overview'],['profile','Login / Profile']];
  baseTabs.forEach(([key,label])=>{
    const b=document.createElement('button'); b.textContent=label; b.dataset.tab=key;
    b.onclick=()=>switchTab(key); if(currentTab===key) b.classList.add('active'); nav.appendChild(b);
  });
  const pIn=el('#managerPinInput'); const pT=el('#managerToggle'); const pS=el('#setManagerPin');
  pT.textContent = isManager()? 'Manager ON' : 'Manager OFF';
  pT.className = 'btn' + (isManager()? ' ok':'' );
  
pT.onclick = async () => {
  // If currently in manager mode, turn it OFF and jump to Overview.
  if (isManager()) {
    currentTab = 'overview';     // land on Overview after re-render
    setSession(null);            // exits manager mode (also re-renders)
    flash('Manager logged out');

    // Clear PIN box so it doesn't linger
    const pIn = el('#managerPinInput');
    if (pIn) pIn.value = '';
    return;
  }

  // Otherwise, trying to turn manager mode ON
  const pinOk = (el('#managerPinInput')?.value || '') === Store.meta.managerPin;
  if (!pinOk) {
    flash('Incorrect PIN');
    return;
  }

  setSession('manager');
  flash('Manager logged in');

  // Clear the PIN right after successful login
  const pIn = el('#managerPinInput');
  if (pIn) pIn.value = '';

  // === keep your existing optional cloud sign-in flow here ===
  // (leave as-is if you already have it)
  if (!window.cloudCanWrite && window.__fb?.auth) {
    try {
      const email = prompt("Manager cloud email (for writes)");
      const pass  = prompt("Manager cloud password");
      if (email && pass) {
        const { signInWithEmailAndPassword } =
          await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
        await signInWithEmailAndPassword(window.__fb.auth, email, pass);
        window.cloudCanWrite = true;
        flash("Cloud: manager signed in");
        if (window.cloud?.save && window.Store) window.cloud.save(window.Store);
      }
    } catch (e) {
      alert("Cloud sign-in failed. Viewing only.");
    }
  }
};



  pS.onclick=()=>{ if(!isManager()) return alert('Login as manager first');
    const next=prompt('Set NEW manager PIN (4-6 digits)', Store.meta.managerPin);
    if(!next) return; if(!/^\d{4,6}$/.test(next)) return alert('PIN must be 4-6 digits');
    Store.meta.managerPin=next; saveStore(Store); flash('Manager PIN updated'); renderSettings();
  };
}


/***** Tab switching *****/
let currentTab='overview';
function switchTab(tab){ currentTab=tab; renderNav(); 
  ['overview','groups','members','payouts','contribs','profile','backup','audit']
  .forEach(t => show(el('#view-'+t), t === tab));
  if(tab==='overview') renderOverview(); 
  if(tab==='groups')   renderGroups();
  if(tab==='members') renderMembers(); 
  if(tab==='payouts') renderPayouts(); 
  if(tab==='contribs') renderContribs(); 
  if(tab==='profile') renderProfile(); 
  if(tab==='backup') renderSettings();
  if(tab==='audit')    renderAudit(); 
 }

function recipientCardHTML(l){
  const m = Store.members.find(x => x.id === l.recipientId);
  if(!m) return '';
  const overdue = (l.status === 'open' && new Date(l.dueDate) < new Date())
    ? `<span class='pill' style='margin-left:6px;border-color:#7f1d1d;background:#3b0d0d;color:#fecaca'>Overdue by ${Math.abs(inDays(todayISO(), l.dueDate))}d</span>`
    : '';

  const donors = (l.fromMembers || [])
    .map(id => Store.members.find(x => x.id === id))
    .filter(Boolean);

  const donorsCount = donors.length;
  const perDonor = (l.perDonorCents != null)
    ? l.perDonorCents
    : (donorsCount ? Math.round((l.amountCents||0)/donorsCount) : 0);

  const amountLine = `
    <div class="small" style="margin-top:4px">
      <span class="muted">Total received:</span> ${ZAR.format((l.amountCents||0)/100)}
      &nbsp;¬∑&nbsp; <span class="muted">Each donor:</span> ${ZAR.format(perDonor/100)} √ó ${donorsCount}
    </div>`;

  const donorHTML = donors.length
    ? donors.map(d => `
        <span class="donor-chip">
          <img src="${d.photoDataUrl || avatarFromName(d.fullName)}" alt="">
          ${escapeHtml(d.fullName)}
        </span>`).join('')
    : `<span class="small muted">No donors recorded</span>`;

  return `
    <div class="card">
      <div class="row" style="align-items:flex-start">
        <img class="avatar" src="${m.photoDataUrl || avatarFromName(m.fullName)}" alt="">
        <div class="grow">
          <div style="font-weight:600">${escapeHtml(m.fullName)}</div>
          <div class="small muted">Age ${m.age} ¬∑ Member since ${m.joinedAt?.slice(0,10) || '‚Äî'}</div>

          ${amountLine}
          <div class="small">
            <span class="muted">Received:</span> ${l.date}
            &nbsp;¬∑&nbsp; <span class="muted">Due:</span> ${l.dueDate}
            ${overdue}
          </div>

          <div class="small muted" style="margin-top:6px">From members:</div>
          <div class="donor-list">${donorHTML}</div>
        </div>
        <button class="btn right" data-details="${l.id}">Details</button>
      </div>
    </div>`;
}


function openRecipientDetails(loanId){
  const l = Store.loans.find(x => x.id === loanId);
  if(!l) return;
  const m = Store.members.find(x => x.id === l.recipientId);
  const donors = (l.fromMembers || [])
    .map(id => Store.members.find(x => x.id === id))
    .filter(Boolean);

  const totalContrib = Store.contributions
    .filter(c => c.memberId === m?.id)
    .reduce((a,c) => a + (c.amountCents||0), 0);
  const totalReceived = Store.loans
    .filter(x => x.recipientId === m?.id)
    .reduce((a,x) => a + (x.amountCents||0), 0);

  const donorRows = donors.length
    ? donors.map(d => `
        <div class="row small" style="justify-content:space-between;border-bottom:1px solid #18202d;padding:4px 0">
          <span><img src="${d.photoDataUrl || avatarFromName(d.fullName)}" class="img-s" style="width:28px;height:28px;margin-right:6px;vertical-align:middle"> ${escapeHtml(d.fullName)}</span>
          <span class="muted">Donor</span>
        </div>`).join('')
    : `<div class="small muted">No donors recorded for this payout.</div>`;

  const card = el('#modalCard');
  card.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">Recipient Details</h3>
      <button class="btn" id="xClose" style="padding:4px 8px">‚úï</button>
    </div>
    <div class="row" style="margin-top:8px">
      <img class="avatar" src="${m?.photoDataUrl || avatarFromName(m?.fullName||'?')}" alt="">
      <div class="grow">
        <div style="font-weight:600">${escapeHtml(m?.fullName||'‚Äî')}</div>
        <div class="small muted">Age ${m?.age ?? '‚Äî'} ¬∑ Member since ${m?.joinedAt?.slice(0,10) || '‚Äî'}</div>
        <div class="small" style="margin-top:6px">
          <span class="muted">This payout:</span> ${ZAR.format(l.amountCents/100)} &nbsp;¬∑&nbsp;
          <span class="muted">Received:</span> ${l.date} &nbsp;¬∑&nbsp;
          <span class="muted">Due:</span> ${l.dueDate} &nbsp;¬∑&nbsp;
          <span class="muted">Status:</span> ${l.status === 'open' ? 'Open' : 'Paid ' + (l.paidBackAt || '')}
        </div>
        <div class="small" style="margin-top:6px">
          <span class="muted">Lifetime received:</span> ${ZAR.format(totalReceived/100)}
          &nbsp;¬∑&nbsp; <span class="muted">Lifetime contributed:</span> ${ZAR.format(totalContrib/100)}
        </div>
      </div>
    </div>
    <div class="card" style="margin-top:10px">
      <div class="small muted" style="margin-bottom:6px">Donors in this payout</div>
      <div class="overflow">${donorRows}</div>
    </div>
  `;
  show(el('#modal'), true);
  el('#xClose').onclick = () => show(el('#modal'), false);
}


/***** Overview *****/
function renderOverview(){
  // Manager Controls (Start/Stop Auto-Play)
  const mc = el('#managerControls');
  if (isManager()){
    show(mc, true);
    Store.meta.autoPlay = Store.meta.autoPlay || {
      enabled:false, startedAt:null, day:1, recipientsPerMonth:1,
      amountCents: Store.meta.defaultContributionCents, lastRunDate:null
    };
    const ap = Store.meta.autoPlay;
    const nextRun = computeNextRunDate();

    // ‚¨áÔ∏è NEW: Cloud Sync controls shown only to manager
    const cloudRow = `
      <div class='row' style='gap:8px;margin:8px 0'>
        <button class='btn' id='cloudSignIn'>Enable Cloud Sync</button>
        <button class='btn' id='cloudSignOut'>Sign out</button>
        <span class='pill' id='cloudStatus'>${window.cloudCanWrite ? 'Online' : 'Offline'}</span>
      </div>
    `;

    if (ap.enabled){
      mc.innerHTML = `
        <div class='row' style='justify-content:space-between'>
          <h3 style='margin:0'>Manager Controls</h3>
          <span class='pill'>Auto-Play ON</span>
        </div>
        ${cloudRow}
        <div class='grid grid-4'>
          <div><div class='small muted'>Recipients/month</div><div class='kpi'>${ap.recipientsPerMonth||1}</div></div>
          <div><div class='small muted'>Amount/recipient</div><div class='kpi'>${ZAR.format((ap.amountCents||Store.meta.defaultContributionCents)/100)}</div></div>
          <div><div class='small muted'>Day of month</div><div class='kpi'>${ap.day}</div></div>
          <div><div class='small muted'>Next run</div><div class='kpi'>${nextRun||'‚Äî'}</div></div>
        </div>
        <div class='row' style='margin-top:8px'>
          <button class='btn' id='runNow'>‚ñ∂ Run this month now</button>
          <button class='btn' id='resetRoundBtn'>‚ôª Start New Round</button>
          <button class='btn danger right' id='stopAuto'>‚èπ Stop</button>
        </div>
        `;
    el('#runNow').onclick = () => {
  const d = todayISO();
  const k = ap.recipientsPerMonth || 1;
  const perDonor = ap.amountCents || Store.meta.defaultContributionCents;

  if (!Store.meta.groups?.locked) buildOrResizeGroups(k);
  createPayoutBatch(d, k, perDonor);

  ap.lastRunDate = d;
  saveStore(Store);

  log('payout_create', { mode:'autoplay_runNow', k, perDonorCents: perDonor, date: d }); // ‚Üê here
  flash('Auto-Play: run created');
  renderOverview(); renderPayouts(); renderProfile();
};

 el('#stopAuto').onclick = () => {
  ap.enabled = false;
  saveStore(Store);
  log('autoplay_stop', {});
  flash('Auto-Play stopped');
  renderOverview();
};

    } else {
      mc.innerHTML = `
        <div class='row' style='justify-content:space-between'>
          <h3 style='margin:0'>Manager Controls</h3>
          <span class='pill'>Auto-Play OFF</span>
        </div>
        ${cloudRow}
        <div class='grid grid-4' style='align-items:end'>
          <label><div class='small muted'>Recipients per month</div><input id='apK' type='number' min='1' value='${ap.recipientsPerMonth||1}'></label>
          <label><div class='small muted'>Amount per recipient (ZAR)</div><input id='apAmt' type='number' min='0' step='0.01' value='${((ap.amountCents??Store.meta.defaultContributionCents)/100).toFixed(2)}'></label>
          <label><div class='small muted'>Day of month</div><input id='apDay' type='number' min='1' max='28' value='${ap.day||new Date().getDate()}'></label>
          <button class='btn primary' id='startAuto'>‚ñ∂ Start Play</button>
        </div>
        <div class='small muted'>Auto-Play rotates randomly without repeats; once everyone has received, a new round starts.</div>`;
    el('#startAuto').onclick = () => {
  const k=Math.max(1, parseInt(el('#apK').value)||1);
  const day=Math.min(28, Math.max(1, parseInt(el('#apDay').value)||new Date().getDate()));
  const amtCents=Math.max(0, Math.round(parseFloat(el('#apAmt').value||'0')*100));
  Store.meta.autoPlay={ enabled:true, startedAt: todayISO(), day, recipientsPerMonth:k,
    amountCents: amtCents||Store.meta.defaultContributionCents, lastRunDate:null };
  saveStore(Store);

  // üëá Audit
  log('autoplay_start', {
    k: Store.meta.autoPlay.recipientsPerMonth,
    day: Store.meta.autoPlay.day,
    perDonorCents: Store.meta.autoPlay.amountCents
  });

  flash('Auto-Play started'); 
  renderOverview();
};


    }

    // ‚¨áÔ∏è NEW: Wire cloud buttons safely
    const cloudBtn = el('#cloudSignIn');
    const cloudOut = el('#cloudSignOut');
    const cloudStatus = el('#cloudStatus');

    if (cloudBtn){
      cloudBtn.onclick = async () => {
        try{
          if (window.cloud?.signIn) {
            await window.cloud.signIn();
          } else {
            alert('Cloud not ready. Make sure the Firebase block is included.');
          }
        } finally {
          if (cloudStatus) cloudStatus.textContent = window.cloudCanWrite ? 'Online' : 'Offline';
        }
      };
    }
    if (cloudOut){
      cloudOut.onclick = async () => {
        if (window.cloud?.signOut) await window.cloud.signOut();
        if (cloudStatus) cloudStatus.textContent = window.cloudCanWrite ? 'Online' : 'Offline';
      };
    }

  } else {
    show(mc, false);
  }

  // KPIs + open recipients (unchanged)
  const activeMembers = Store.members.filter(m=>m.active!==false).length;
  el('#stat-members').textContent=String(activeMembers);
  const totalContrib = Store.contributions.reduce((a,c)=>a+(c.amountCents||0),0);
  const totalLoaned = Store.loans.reduce((a,l)=>a+(l.amountCents||0),0);
  const outstanding = Store.loans.filter(l=>l.status==='open').reduce((a,l)=>a+l.amountCents,0);
  el('#stat-contrib').textContent=ZAR.format(totalContrib/100);
  el('#stat-loaned').textContent=ZAR.format(totalLoaned/100);
  el('#stat-outstanding').textContent=ZAR.format(outstanding/100);

  el('#roundCycle').textContent = String(Store.rounds.cycle);
  el('#roundServed').textContent = String(Store.rounds.servedIds.length);
  el('#roundTotal').textContent = String(activeMembers);

  const open = Store.loans.filter(l => l.status === 'open');
const wrap = el('#openRecipients'); wrap.innerHTML = '';
if (open.length === 0) {
  show(el('#noOpenRecipients'), true);
} else {
  show(el('#noOpenRecipients'), false);
  wrap.innerHTML = open.map(recipientCardHTML).join('');
  wrap.querySelectorAll('[data-details]').forEach(btn => {
    btn.onclick = () => openRecipientDetails(btn.dataset.details);
  });
}


  addResetUI();
  addLoanResetUI();
  addReminderUI();
}



function memberCardHTML(m, extra=''){
  const img = m.photoDataUrl || avatarFromName(m.fullName);
  return `<div class='card hstack'>
    <img src='${img}' class='avatar'>
    <div class='grow'>
      <div style='font-weight:600'>${escapeHtml(m.fullName)}</div>
      <div class='small muted'>Age ${m.age} ¬∑ Joined ${m.joinedAt?.slice(0,10)||'‚Äî'}</div>
      ${extra}
    </div>
  </div>`
}

/***** Members *****/
function renderMembers(){
  el('#addMemberBtn').onclick = ()=>{ if(!isManager()) return alert('Manager login required'); openAddMember() };
  const q = el('#memberSearch').value?.toLowerCase()||'';
  const list = el('#memberList'); list.innerHTML='';
  const filtered = Store.members.filter(m=> (m.fullName+' '+m.age).toLowerCase().includes(q));
  show(el('#memberTip'), Store.members.length===0);
  filtered.forEach(m=>{
    const img = m.photoDataUrl || avatarFromName(m.fullName);
    const div=document.createElement('div'); div.className='card hstack';
    div.innerHTML=`<img src='${img}' class='avatar'>
      <div class='grow'>
        <div style='font-weight:600'>${escapeHtml(m.fullName)}</div>
        <div class='small muted'>Age ${m.age} ¬∑ Member since ${m.joinedAt?.slice(0,10)||'‚Äî'}</div>
        <div class='small'>Password: <code class='pill'>${m.password}</code> <button class='btn' style='padding:4px 8px'>Copy</button></div>
      </div>
      <div class='hstack'>
        <button class='btn' data-viewjson>View JSON</button>
        <button class='btn danger' data-remove>Remove</button>
      </div>`;
    div.querySelector('button').onclick=()=>copy(m.password);
    div.querySelector('[data-viewjson]').onclick=()=>alert(JSON.stringify(m,null,2));
    div.querySelector('[data-remove]').onclick=()=>{ if(!isManager()) return alert('Manager login required'); if(confirm('Remove '+m.fullName+'?')){
      Store.members=Store.members.filter(x=>x.id!==m.id);
      Store.rounds.servedIds = Store.rounds.servedIds.filter(id=>id!==m.id);
      saveStore(Store); 

      saveStore(Store);
// üëá Audit
      log('member_remove', { id: m.id, name: m.fullName });

      flash('Member removed'); 
      renderMembers(); renderContribs(); renderPayouts(); renderOverview();
    } };
    list.appendChild(div);
  })
}

function openAddMember(){
  const card=el('#modalCard');
  card.innerHTML=`<div class='row' style='justify-content:space-between'><h3 style='margin:0'>Add Member</h3><button class='btn' id='xClose' style='padding:4px 8px'>‚úï</button></div>
  <div class='grid grid-2'>
    <label><div class='small muted'>Full name</div><input id='mName' placeholder='e.g., Desire Kakwava'></label>
    <label><div class='small muted'>Age</div><input id='mAge' type='number' min='10' max='120' placeholder='29'></label>
    <label class='row'><img id='mPrev' class='img-s' src='${avatarFromName('N')}'><div><div class='small muted'>Profile picture</div><input id='mPhoto' type='file' accept='image/*'></div></label>
    <label><div class='small muted'>Unique login password</div><div class='row'><input id='mPw'><button class='btn' id='regen' style='padding:8px 10px'>Regenerate</button><button class='btn' id='copyPw' style='padding:8px 10px'>Copy</button></div></label>
  </div>
  <div class='row' style='justify-content:flex-end;margin-top:10px'>
    <button class='btn' id='create'>Create</button>
  </div>`;
  show(el('#modal'), true);
  const pwInput = el('#mPw'); pwInput.value = genPassword();
  el('#regen').onclick=()=>{ pwInput.value = genPassword() };
  el('#copyPw').onclick=()=>copy(pwInput.value);
  el('#mPhoto').onchange=async e=>{ const f=e.target.files?.[0]; if(f){ el('#mPrev').src = await readAsDataURL(f) } };
  el('#xClose').onclick=()=>show(el('#modal'), false);
  el('#create').onclick=()=>{
    const fullName=el('#mName').value.trim(); const age = clamp(parseInt(el('#mAge').value)||0,10,120);
    const password=pwInput.value.trim(); const img=el('#mPrev').src.startsWith('data:')? el('#mPrev').src : null;
    if(!fullName || !age) return alert('Full name and age are required');
    if(Store.members.some(m=>m.password===password)) return alert('Password already in use. Regenerate.');
    const mem={ id:uid(), fullName, age, password, photoDataUrl: img, joinedAt:new Date().toISOString(), active:true };
  Store.members = [mem, ...Store.members];
saveStore(Store);

// üëá Audit
log('member_add', { id: mem.id, name: mem.fullName });

show(el('#modal'), false);
flash('Member added');
renderMembers(); renderContribs(); renderPayouts(); renderOverview();

  };
}

function genPassword(){ const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; return Array.from({length:8},()=>chars[Math.floor(Math.random()*chars.length)]).join('') }

/* ===== Group helpers (balanced, persistent) ===== */
function activeMemberIds(){ return Store.members.filter(m=>m.active!==false).map(m=>m.id); }

function buildOrResizeGroups(k){
  k = Math.max(1, Math.min(k, activeMemberIds().length || 1));
  const actives = activeMemberIds();
  const oldMap = (Store.meta.groups && Store.meta.groups.map) || {};
  const map = {};

  // keep existing where still valid
  for(const id of actives){
    const g = oldMap[id];
    if(Number.isInteger(g) && g>=0 && g<k) map[id]=g;
  }

  // balance the rest
  const counts = Array(k).fill(0);
  for(const id in map) counts[map[id]]++;
  for(const id of actives){
    if(map[id]!=null) continue;
    let gi = 0, min = counts[0];
    for(let i=1;i<k;i++) if(counts[i] < min){ gi=i; min=counts[i]; }
    map[id]=gi; counts[gi]++;
  }

  Store.meta.groups = { locked:true, k, map };
  saveStore(Store);
}

function getGroupIndex(id){
  const g = Store.meta.groups;
  return (g && g.map && Number.isInteger(g.map[id])) ? g.map[id] : 0;
}

function groupMemberIds(gi){
  return Store.members.filter(m => m.active!==false && getGroupIndex(m.id)===gi).map(m=>m.id);
}

function pickRecipientsPerGroup(){
  const g = Store.meta.groups;
  if(!g?.locked) return [];
  const picks=[];
  for(let gi=0; gi<g.k; gi++){
    const grp = groupMemberIds(gi);
    const elig = grp.filter(id => !Store.rounds.servedIds.includes(id));
    if(elig.length){
      picks.push( pickRandom(elig, 1)[0] );
    }
  }
  return picks;
}

/* donors from same group as recipient, excluding the recipient */
function assignGiversGrouped(recipientIds){
  const map = {};
  for(const rid of recipientIds){
    const gi = getGroupIndex(rid);
    const grp = groupMemberIds(gi);
    map[rid] = grp.filter(id => id !== rid);
  }
  return map; // { recipientId: [giverId,...] }
}


/* ===== Groups manager helpers ===== */
function ensureGroupNames(){
  const g = Store.meta.groups || (Store.meta.groups = {locked:false,k:1,map:{},names:["Group 1"]});
  if (!Array.isArray(g.names) || g.names.length !== (g.k||1)) {
    g.names = Array.from({length:g.k||1}, (_,i)=> g.names?.[i] || `Group ${i+1}`);
  }
}

function renameGroup(index, name){
  ensureGroupNames();
  Store.meta.groups.names[index] = name || `Group ${index+1}`;
  saveStore(Store);
}

function groupName(i){
  ensureGroupNames();
  return Store.meta.groups.names[i] || `Group ${i+1}`;
}

function rebalanceGroups(){
  // reuse your existing builder to rebalance evenly with same K
  buildOrResizeGroups(Store.meta.groups.k || 1);
}

function renderGroups(){
  if(!isManager()){ switchTab('overview'); return; }
  ensureGroupNames();

  const k = Store.meta.groups.k || 1;
  el('#groupsK').value = k;
  el('#groupsState').textContent = Store.meta.groups.locked ? `Locked (${k})` : 'Unlocked';

  const wrap = el('#groupsWrap'); wrap.innerHTML = '';

  // build columns
  for(let gi=0; gi<k; gi++){
    const col = document.createElement('div');
    col.className = 'groupCol';
    col.dataset.groupIndex = String(gi);

    col.innerHTML = `
      <div class="groupHeader">
        <span class="pill">G${gi+1}</span>
        <input class="groupTitle" value="${escapeHtml(groupName(gi))}" />
        <span class="small muted right">${groupMemberIds(gi).length} member(s)</span>
      </div>
      <div class="groupList" data-gi="${gi}"></div>
    `;

    // members
    const ids = groupMemberIds(gi);
    const list = col.querySelector('.groupList');
    ids.forEach(id=>{
      const m = Store.members.find(x=>x.id===id); if(!m) return;
      const chip = document.createElement('div');
      chip.className = 'memberChip';
      chip.draggable = true;
      chip.dataset.mid = id;
      chip.innerHTML = `<img src="${m.photoDataUrl || avatarFromName(m.fullName)}" class="img-s" style="width:28px;height:28px">
                        <div class="grow">${escapeHtml(m.fullName)}</div>`;
      list.appendChild(chip);
    });

    // DnD
    col.addEventListener('dragover', (e)=>{ e.preventDefault(); col.classList.add('dragOver'); });
    col.addEventListener('dragleave', ()=> col.classList.remove('dragOver'));
    col.addEventListener('drop', (e)=>{
      e.preventDefault(); col.classList.remove('dragOver');
      const mid = e.dataTransfer.getData('text/mid');
      if(!mid) return;
      Store.meta.groups.map[mid] = gi;
      saveStore(Store);
      renderGroups();
    });

    col.addEventListener('dragstart', (e)=>{
      const target = e.target.closest('.memberChip');
      if(!target) return;
      target.classList.add('dragging');
      e.dataTransfer.setData('text/mid', target.dataset.mid);
      e.dataTransfer.effectAllowed = 'move';
    });
    col.addEventListener('dragend', (e)=>{
      const t = e.target.closest('.memberChip');
      if(t) t.classList.remove('dragging');
    });

    // rename
    col.querySelector('.groupTitle').addEventListener('change', (ev)=>{
      renameGroup(gi, ev.target.value.trim());
      renderGroups();
    });

    wrap.appendChild(col);
  }

  // controls
  el('#groupsResize').onclick = ()=>{
    const k = Math.max(1, parseInt(el('#groupsK').value)||1);
    buildOrResizeGroups(k);
    ensureGroupNames();
    Store.meta.groups.names = Array.from({length:k}, (_,i)=> Store.meta.groups.names?.[i] || `Group ${i+1}`);
    saveStore(Store);
    flash(`Groups resized to ${k} and locked`);
    renderGroups();
  };
  el('#groupsRebalance').onclick = ()=>{ rebalanceGroups(); flash('Groups rebalanced'); renderGroups(); };
  el('#groupsUnlock').onclick = ()=>{
    Store.meta.groups.locked = false;
    saveStore(Store);
    flash('Groups unlocked (rotation keeps going; you can relock with a new K)');
    renderGroups();
  };
}


/***** Fair Rotation (Random Selection) *****/
function getEligibleIds(){
  const activeIds = Store.members.filter(m=>m.active!==false).map(m=>m.id);
  // Drop any servedIds that no longer exist
  Store.rounds.servedIds = Store.rounds.servedIds.filter(id=>activeIds.includes(id));
  const eligible = activeIds.filter(id=> !Store.rounds.servedIds.includes(id));
  // If none eligible but there are members, start a new cycle
  if(eligible.length===0 && activeIds.length>0){ Store.rounds.cycle += 1; Store.rounds.servedIds = []; saveStore(Store); return [...activeIds] }
  return eligible;
}
function pickRandom(ids, k){
  const arr=[...ids]; const n=Math.min(k, arr.length);
  for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] }
  return arr.slice(0,n);
}

// Assign remaining active members to each recipient (random, round-robin)
function assignGivers(recipientIds){
  const activeIds = Store.members.filter(m => m.active !== false).map(m => m.id);
  const giverPool = activeIds.filter(id => !recipientIds.includes(id));

  // shuffle the givers
  const shuffled = [...giverPool];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }

  // round-robin distribute givers to recipients
  const map = Object.fromEntries(recipientIds.map(id => [id, []]));
  let i = 0;
  for (const gid of shuffled) {
    const rid = recipientIds[i % recipientIds.length];
    map[rid].push(gid);
    i++;
  }
  return map; // { recipientId: [giverId, ...] }
}



/*===== Auto-Play (Monthly Rotation) =====*/
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate() }
function monthDate(y,m,d){ return new Date(y, m, Math.min(d, daysInMonth(y,m))) }
function addMonthsDate(d,n,day){
  const y=d.getFullYear(), m=d.getMonth();
  const base=new Date(y,m,1);
  const nm=new Date(base.setMonth(base.getMonth()+n));
  return monthDate(nm.getFullYear(), nm.getMonth(), day);
}
function computeNextRunDate(){
  const ap=Store.meta.autoPlay; if(!ap?.enabled||!ap.startedAt) return null;
  const start=new Date(ap.startedAt); const day=ap.day||start.getDate();
  const next = ap.lastRunDate? addMonthsDate(new Date(ap.lastRunDate),1,day)
                             : monthDate(start.getFullYear(), start.getMonth(), day);
  return todayISO(next);
}
function createPayoutBatch(dateStr, k, perDonorCents){
  // global cycle reset if needed
  let eligible = getEligibleIds();
  if (eligible.length === 0) {
    const actives = activeMemberIds();
    if (!actives.length) return;
    Store.rounds.cycle += 1;
    Store.rounds.servedIds = [];
    eligible = getEligibleIds();
  }

  // ensure/lock groups when manager set a round pattern (k groups)
  if (!Store.meta.groups?.locked) {
    buildOrResizeGroups(Math.max(1, k||1));
  } else if (k && Store.meta.groups.k !== k) {
    // if caller explicitly requests a new k, re-balance into that k and keep locked
    buildOrResizeGroups(k);
  }

  // one recipient per group (where eligible remain)
  const chosen = pickRecipientsPerGroup();
  if (chosen.length === 0) return;

  // donors = members of the same group (minus recipient)
  const giverMap = assignGiversGrouped(chosen);

  const loans = chosen.map(rid => {
    const donors = giverMap[rid] || [];
    const totalCents = (perDonorCents||0) * donors.length;   // total = per-donor √ó (#group-1)
    // due date = +1 month, same day, clamped
    const runDate = new Date(dateStr);
    const due     = addMonthsDate(runDate, 1, runDate.getDate());
    return {
      id: uid(),
      recipientId: rid,
      perDonorCents: perDonorCents||0,     // üëà NEW: store per-donor amount
      amountCents: totalCents,             // total the recipient gets
      date: dateStr,
      dueDate: todayISO(due),
      fromMembers: donors,
      status: 'open'
    };
  });

  // mark served (fair rotation across all groups)
  Store.rounds.servedIds = Array.from(new Set([...Store.rounds.servedIds, ...chosen]));

  // persist
  Store.loans = [...loans, ...Store.loans];
  saveStore(Store);
}



function autoPlayTick(){
  const ap=Store.meta.autoPlay; if(!ap?.enabled || !Store.members.length) return;
  if(!ap.startedAt) ap.startedAt = todayISO();
  if(!ap.day){ const d=new Date(ap.startedAt); ap.day=d.getDate(); }
  const amt=ap.amountCents||Store.meta.defaultContributionCents;
  const start=new Date(ap.startedAt);
  let cursor = ap.lastRunDate? addMonthsDate(new Date(ap.lastRunDate),1, ap.day)
                             : monthDate(start.getFullYear(), start.getMonth(), ap.day);
  const today=new Date(); let ran=false;
  while(cursor<=today){
    createPayoutBatch(todayISO(cursor), ap.recipientsPerMonth||1, amt);
    ap.lastRunDate = todayISO(cursor);
    cursor = addMonthsDate(cursor,1, ap.day);
    ran=true;
  }
  if(ran) saveStore(Store);
}


/***** Payouts *****/
function renderPayouts(){
  el('#randomSelectBtn').onclick=()=>{ if(!isManager()) return alert('Manager login required'); openRandomSelect() };
  const q = el('#payoutSearch').value?.toLowerCase()||'';
  const list = el('#payoutList'); list.innerHTML='';
  const loans = Store.loans.filter(l=>{ const m = Store.members.find(x=>x.id===l.recipientId); return !q || m?.fullName?.toLowerCase().includes(q) }).sort((a,b)=> new Date(b.date)-new Date(a.date));
  show(el('#payoutEmpty'), loans.length===0);
  loans.forEach(l=>{
    const m = Store.members.find(x=>x.id===l.recipientId); if(!m) return;
    const div=document.createElement('div'); div.className='card';
  div.innerHTML = memberCardHTML(m, `
  <div class='small'>
    <div><span class='muted'>Total received:</span> ${ZAR.format((l.amountCents||0)/100)}</div>
    <div class='small'><span class='muted'>Each donor:</span> ${ZAR.format((l.perDonorCents||0)/100)} √ó ${(l.fromMembers||[]).length}</div>
    <div><span class='muted'>Received:</span> ${l.date}</div>
    <div><span class='muted'>Due:</span> ${l.dueDate} ${
      (l.status==='open' && new Date(l.dueDate)<new Date())
        ? `<span class='pill' style='margin-left:6px;border-color:#7f1d1d;background:#3b0d0d;color:#fecaca'>Overdue</span>` : ''
    }</div>
    <div class='muted small'>
      From members: ${
        (l.fromMembers||[])
          .map(id => Store.members.find(x=>x.id===id)?.fullName)
          .filter(Boolean).join(', ') || '‚Äî'
      }
    </div>
  </div>
  <div class='row' style='margin-top:8px'>
    ${ l.status==='open'
        ? `<button class='btn ok' data-paid>Mark Paid</button>`
        : `<span class='pill'>Paid on ${l.paidBackAt||''}</span>` }
    <button class='btn' data-json>Details</button>
    <button class='btn danger right' data-del>Delete</button>
  </div>
`);

    div.querySelector('[data-json]').textContent = 'Details';
    div.querySelector('[data-json]').onclick = () => openRecipientDetails(l.id);
    div.querySelector('[data-del]').onclick=()=>{ if(!isManager()) return alert('Manager login required'); 
    if(confirm('Delete this payout?')){ Store.loans=Store.loans.filter(x=>x.id!==l.id); 
    saveStore(Store); 
    flash('Payout deleted'); 
    renderPayouts(); renderOverview() } };
    const paidBtn = div.querySelector('[data-paid]'); 
    if(paidBtn) paidBtn.onclick=()=>{ 
    if(!isManager()) return alert('Manager login required'); 
    if(confirm('Confirm: mark as PAID BACK?'))

    { Store.loans = Store.loans.map(x=> x.id===l.id? 
    {...x, status:'paid', paidBackAt: todayISO() }: x ); 

    saveStore(Store); flash('Marked as paid'); 
    log('payout_mark_paid', { id: l.id, paidBackAt: todayISO() });
    renderPayouts(); 
    renderOverview() } };
  })
}

function openRandomSelect(){
  const members = Store.members.filter(m=>m.active!==false);
  if(members.length===0) return alert('Add members first');
  const eligible = getEligibleIds();
  const d = new Date(); d.setMonth(d.getMonth()+1);
  const defDue = todayISO(d);
  const defAmt = (Store.meta.defaultContributionCents/100).toFixed(2);
  const card=el('#modalCard');
  card.innerHTML=`<div class='row' style='justify-content:space-between'><h3 style='margin:0'>üé≤ Random Select & Lend</h3><button class='btn' id='xClose' style='padding:4px 8px'>‚úï</button></div>
  <div class='grid grid-2'>
    <div class='grid'>
      // label text in the modal HTML:
      <label><div class='small muted'>Groups / recipients to pick (per round)</div>
      <input id='pickK' type='number' min='1' max='${Math.max(eligible.length,1)}' value='1'></label>
      <label><div class='small muted'>Amount per recipient (ZAR)</div><input id='pAmt' type='number' min='0' step='0.01' value='${defAmt}'></label>
      <label><div class='small muted'>Received on</div><input id='pDate' type='date' value='${todayISO()}'></label>
      <label><div class='small muted'>Due date</div><input id='pDue' type='date' value='${defDue}'></label>
      <div class='small muted'>Eligible now: ${eligible.length}/${members.length}. Round ${Store.rounds.cycle}.</div>
      <label class='small' style='display:block;margin-top:6px'>
      <input id='lockGroupsNow' type='checkbox' checked>
      Lock into this many rotating group(s) until everyone has received
    </label>

      <div class='row'><button class='btn' id='previewBtn'>Preview Selection</button><button class='btn primary right' id='create'>Create Payout(s)</button></div>
    </div>
    <div>
      <div class='small muted' style='margin-bottom:6px'>Selection preview</div>
      <div class='overflow' id='previewWrap'></div>
    </div>
  </div>`;
  show(el('#modal'), true);
  el('#xClose').onclick=()=>show(el('#modal'), false);

  function renderPreview(){
    const k = Math.max(1, Math.min(parseInt(el('#pickK').value)||1, getEligibleIds().length||1));
    const chosen = pickRandom(getEligibleIds(), k);
    const wrap=el('#previewWrap'); wrap.innerHTML='';
    if(chosen.length===0){ wrap.innerHTML = `<div class='muted small'>No eligible members. A new round will start after you confirm.</div>`; return }
    chosen.forEach(id=>{ const m=Store.members.find(x=>x.id===id); if(!m) return; wrap.insertAdjacentHTML('beforeend', `<div class='card hstack'><img class='img-s' src='${m.photoDataUrl||avatarFromName(m.fullName)}'><div class='grow'><div style='font-weight:600'>${escapeHtml(m.fullName)}</div><div class='small muted'>Age ${m.age}</div></div></div>`) })
    return chosen;
  }
  el('#previewBtn').onclick=renderPreview;
  const initial=renderPreview();

el('#create').onclick = () => {
  let k = Math.max(1, Math.min(parseInt(el('#pickK').value)||1, (getEligibleIds().length || activeMemberIds().length || 1)));
  const perDonorCents = Math.max(0, Math.round(parseFloat(el('#pAmt').value||'0')*100));
  const date    = el('#pDate').value || todayISO();
  const dueDate = el('#pDue').value  || todayISO();
  const lockNow = !!el('#lockGroupsNow')?.checked;

  if (lockNow || !Store.meta.groups?.locked) buildOrResizeGroups(k);

  // If a whole cycle is complete, getEligibleIds() will reset automatically
  if (activeMemberIds().length === 0) return alert('No active members');

  // The grouped function will choose one eligible per group
  createPayoutBatch(date, Store.meta.groups.k, perDonorCents);

  show(el('#modal'), false);
  flash('Payout(s) created');
  renderPayouts(); renderOverview(); renderProfile();
};

}

/***** Contributions *****/
function renderContribs(){
  const sel = el('#contribMember'); sel.innerHTML='';
  Store.members.forEach(m=> sel.insertAdjacentHTML('beforeend', `<option value='${m.id}'>${escapeHtml(m.fullName)}</option>`));
  el('#contribAmount').value = (Store.meta.defaultContributionCents/100).toFixed(2);
  el('#contribDate').value = todayISO();
  el('#recordContrib').onclick=()=>{ if(!isManager()) return alert('Manager login required');
    const memberId = el('#contribMember').value; if(!memberId) return alert('Select member');
    const amountCents = Math.max(0, Math.round(parseFloat(el('#contribAmount').value||'0')*100)); if(!amountCents) return alert('Enter a valid amount');
    const date = el('#contribDate').value || todayISO();
    Store.contributions=[{id:uid(), memberId, amountCents, date, note:'Monthly contribution'}, ...Store.contributions]; saveStore(Store); log('contrib_record', { memberId, amountCents, date });
 flash('Contribution recorded'); renderContribs(); renderOverview(); renderProfile();
  };

  const q = el('#contribSearch').value?.toLowerCase()||'';
  const rows = Store.contributions.filter(c=>{ const m=Store.members.find(x=>x.id===c.memberId); return !q || m?.fullName?.toLowerCase().includes(q) }).sort((a,b)=> new Date(b.date)-new Date(a.date));
  el('#contribTotal').textContent = 'Total: '+ ZAR.format(rows.reduce((a,r)=>a+r.amountCents,0)/100);
  const tbody = el('#contribTable'); tbody.innerHTML='';
  rows.forEach(r=>{ const m=Store.members.find(x=>x.id===r.memberId); tbody.insertAdjacentHTML('beforeend', `<tr><td>${r.date}</td><td>${escapeHtml(m?.fullName||'‚Äî')}</td><td>${ZAR.format(r.amountCents/100)}</td><td>${r.note||'‚Äî'}</td></tr>`) });
}

/***** Profile / Login & Signup *****/
function renderProfile(){
  // login recipients panel
const open = Store.loans.filter(l => l.status === 'open');
const wrap = el('#loginRecipients'); wrap.innerHTML = '';
if (open.length === 0) {
  show(el('#loginRecipientsEmpty'), true);
} else {
  show(el('#loginRecipientsEmpty'), false);
  wrap.innerHTML = open.map(recipientCardHTML).join('');
  wrap.querySelectorAll('[data-details]').forEach(btn => {
    btn.onclick = () => openRecipientDetails(btn.dataset.details);
  });
}



  // session
  if(isMember()){
    show(el('#loginPanel'), false); show(el('#mePanel'), true);
    const me = Store.members.find(m=>m.id===Store.session.memberId); if(!me){ setSession(null); return }
    el('#meAvatar').src = me.photoDataUrl || avatarFromName(me.fullName);
    el('#meName').textContent = me.fullName;
    el('#meAge').textContent = me.age;
    el('#meJoined').textContent = (me.joinedAt||'').slice(0,10);
    el('#mePw').textContent = me.password;
    el('#copyPw').onclick=()=>copy(me.password);
    el('#switchAccount').onclick=()=> setSession(null);

    const myContribs = Store.contributions.filter(c=>c.memberId===me.id).sort((a,b)=> new Date(b.date)-new Date(a.date));
    const myLoans = Store.loans.filter(l=>l.recipientId===me.id).sort((a,b)=> new Date(b.date)-new Date(a.date));
    el('#mePaid').textContent = ZAR.format(myContribs.reduce((a,c)=>a+c.amountCents,0)/100);
    el('#meReceived').textContent = ZAR.format(myLoans.reduce((a,l)=>a+l.amountCents,0)/100);
    const cWrap=el('#meContribs'); cWrap.innerHTML=''; myContribs.forEach(c=> cWrap.insertAdjacentHTML('beforeend', `<div class='row small' style='justify-content:space-between;border-bottom:1px solid #18202d;padding:4px 0'><span>${c.date}</span><span>${ZAR.format(c.amountCents/100)}</span></div>`)); if(myContribs.length===0) cWrap.innerHTML='<div class="small muted">No contributions yet.</div>';
    const lWrap=el('#meLoans'); lWrap.innerHTML=''; myLoans.forEach(l=> lWrap.insertAdjacentHTML('beforeend', `<div class='card small'><div class='row' style='justify-content:space-between'><span>Amount</span><span>${ZAR.format(l.amountCents/100)}</span></div><div class='row muted small' style='justify-content:space-between'><span>Received</span><span>${l.date}</span></div><div class='row muted small' style='justify-content:space-between'><span>Due</span><span>${l.dueDate}</span></div><div class='small'>${l.status==='open'? `<span class='pill'>Open</span>`: `<span class='pill'>Paid ${l.paidBackAt||''}</span>`}</div></div>`)); if(myLoans.length===0) lWrap.innerHTML='<div class="small muted">You haven‚Äôt received money yet.</div>';
    el('#meReminder').textContent = myLoans.some(l=> l.status==='open' && new Date(l.dueDate)<new Date()) ? 'Reminder: Your payout is overdue. Please settle as soon as possible.' : '';
    return;
  }

  show(el('#loginPanel'), true); show(el('#mePanel'), false);
  el('#loginBtn').onclick=()=>{
    const role = el('#loginRole').value; const pw = el('#loginPw').value.trim(); if(!pw) return;
    if(role==='manager'){ if(pw===Store.meta.managerPin){ setSession('manager'); flash('Manager logged in') } else alert('Incorrect manager PIN') }
    else{
      const m = Store.members.find(x=>x.password===pw); if(!m) return alert('Password not found. Ask your manager for your password or sign up.'); setSession('member', m.id);
    }
  };
}

function openSignup(){
  const card=el('#modalCard');
  card.innerHTML=`<div class='row' style='justify-content:space-between'><h3 style='margin:0'>Create Your Profile</h3><button class='btn' id='xClose' style='padding:4px 8px'>‚úï</button></div>
  <div class='grid'>
    <label><div class='small muted'>Full name</div><input id='sName'></label>
    <label><div class='small muted'>Age</div><input id='sAge' type='number' min='10' max='120'></label>
    <label><div class='small muted'>Profile picture</div><input id='sPhoto' type='file' accept='image/*'></label>
    <label><div class='small muted'>Your unique password</div><div class='row'><input id='sPw'><button class='btn' id='regen' style='padding:8px 10px'>Regenerate</button><button class='btn' id='copyPw' style='padding:8px 10px'>Copy</button></div></label>
  </div>
  <div class='row' style='justify-content:flex-end;margin-top:10px'><button class='btn primary' id='create'>Create Profile</button></div>`;
  show(el('#modal'), true);
  const pwInput=el('#sPw'); pwInput.value=genPassword(); el('#regen').onclick=()=> pwInput.value=genPassword(); el('#copyPw').onclick=()=>copy(pwInput.value);
  let imgData=null; el('#sPhoto').onchange=async e=>{ const f=e.target.files?.[0]; if(f) imgData=await readAsDataURL(f) };
  el('#xClose').onclick=()=>show(el('#modal'), false);
  el('#create').onclick=()=>{
    const fullName=el('#sName').value.trim(); const age=clamp(parseInt(el('#sAge').value)||0,10,120); const pw=pwInput.value.trim();
    if(!fullName||!age) return alert('Full name and age are required');
    if(Store.members.some(m=>m.password===pw)) return alert('Password already in use. Regenerate.');
    const mem={ id:uid(), fullName, age, password:pw, photoDataUrl: imgData, joinedAt:new Date().toISOString(), active:true };
    Store.members=[mem, ...Store.members]; saveStore(Store); show(el('#modal'), false); flash('Profile created ‚Äî keep your password safe!'); switchTab('profile'); setSession('member', mem.id);
  };
}

function printLogs(){
  const fmtZAR = cents => ZAR.format((cents||0)/100);
  const members = Object.fromEntries(Store.members.map(m=>[m.id, m]));
  const byDateAsc = (a,b)=> new Date(a.date) - new Date(b.date);

  const contribs = [...Store.contributions].sort(byDateAsc);
  const loans    = [...Store.loans].sort(byDateAsc);

  const totalContrib    = contribs.reduce((a,c)=>a+(c.amountCents||0),0);
  const totalLoaned     = loans.reduce((a,l)=>a+(l.amountCents||0),0);
  const totalOutstanding= loans.filter(l=>l.status==='open').reduce((a,l)=>a+(l.amountCents||0),0);

  const rowsContrib = contribs.map(c =>
    `<tr>
      <td>${c.date}</td>
      <td>${escapeHtml(members[c.memberId]?.fullName || '‚Äî')}</td>
      <td>${fmtZAR(c.amountCents)}</td>
      <td>${escapeHtml(c.note || '')}</td>
    </tr>`
  ).join('');

  const rowsLoans = loans.map(l => {
    const rec = members[l.recipientId];
    const status = l.status==='open' ? 'Open' : `Paid ${l.paidBackAt||''}`;
    const fromNames = (l.fromMembers||[])
      .map(id=> members[id]?.fullName)
      .filter(Boolean).join(', ');
    return `<tr>
      <td>${l.date}</td>
      <td>${escapeHtml(rec?.fullName || '‚Äî')}</td>
      <td>${fmtZAR(l.amountCents)}</td>
      <td>${l.dueDate}</td>
      <td>${escapeHtml(status)}</td>
      <td class="small">${escapeHtml(fromNames || '‚Äî')}</td>
    </tr>`;
  }).join('');

  const today = new Date().toLocaleString();

  const html = `<!doctype html><html><head><meta charset="utf-8">
  <title>Money Circle ‚Äî Logs</title>
  <style>
    @page { size: A4; margin: 16mm; }
    body { font: 12px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#111; }
    h1 { font-size: 20px; margin: 0 0 2mm; }
    h2 { font-size: 14px; margin: 8mm 0 2mm; }
    .muted{ color:#555 }
    .small{ font-size:11px }
    .kpis{ display:flex; gap:12px; margin: 4mm 0; flex-wrap: wrap; }
    .kpi{ padding:8px 10px; border:1px solid #ddd; border-radius:8px; }
    table{ width:100%; border-collapse:collapse; page-break-inside:auto }
    thead{ display:table-header-group }
    th,td{ border:1px solid #ddd; padding:6px 8px; text-align:left; vertical-align:top }
    th{ background:#f3f4f6 }
    .footer{ margin-top:8mm; color:#666; font-size:10px }
    .noprint{ text-align:right; margin-bottom:6mm }
    @media print { .noprint{ display:none } }
  </style>
  </head><body>
    <div class="noprint"><button onclick="print()">Print / Save as PDF</button></div>
    <h1>Money Circle ‚Äî Logs</h1>
    <div class="small muted">Generated ${today}</div>

    <div class="kpis">
      <div class="kpi"><div class="small muted">Active Members</div><div>${Store.members.filter(m=>m.active!==false).length}</div></div>
      <div class="kpi"><div class="small muted">Total Contributions</div><div>${fmtZAR(totalContrib)}</div></div>
      <div class="kpi"><div class="small muted">Total Loaned Out</div><div>${fmtZAR(totalLoaned)}</div></div>
      <div class="kpi"><div class="small muted">Outstanding</div><div>${fmtZAR(totalOutstanding)}</div></div>
    </div>

    <h2>Contributions</h2>
    <table>
      <thead><tr><th>Date</th><th>Member</th><th>Amount (ZAR)</th><th>Note</th></tr></thead>
      <tbody>${rowsContrib || '<tr><td colspan="4" class="muted">No contributions recorded.</td></tr>'}</tbody>
    </table>

    <h2>Payouts / Loans</h2>
    <table>
      <thead><tr><th>Received</th><th>Recipient</th><th>Amount (ZAR)</th><th>Due</th><th>Status</th><th class="small">From Members</th></tr></thead>
      <tbody>${rowsLoans || '<tr><td colspan="6" class="muted">No payouts recorded.</td></tr>'}</tbody>
    </table>

    <div class="footer">Source: local key ‚Äúmoney-circle-vanilla-v2‚Äù.</div>
  </body></html>`;

  const w = window.open('', '_blank');
  if (!w) return alert('Popup blocked. Allow popups for this site.');
  w.document.open(); w.document.write(html); w.document.close();
  w.onload = () => w.print();
  
}

window.downloadCSV = function(filename, headers, rows) { /* ...same body... */ };
window.buildContribCSV = function() { /* ...same body... */ };
window.buildPayoutsCSV = function() { /* ...same body... */ };


/***** Backup & Settings *****/
function renderSettings(){
  el('#defAmount').value = (Store.meta.defaultContributionCents/100).toFixed(2);
  el('#managerEdit').value = Store.meta.managerPin;
  el('#managerDisplay').textContent = Store.meta.managerPin;
  el('#saveSettings').onclick=()=>{ if(!isManager()) return alert('Manager login required'); const cents = Math.max(0, Math.round(parseFloat(el('#defAmount').value||'0')*100)); Store.meta.defaultContributionCents=cents; Store.meta.managerPin=el('#managerEdit').value||Store.meta.managerPin; saveStore(Store); flash('Settings saved'); renderSettings() };
  el('#exportBtn').onclick=()=>{ const blob=new Blob([JSON.stringify(Store,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`money-circle-backup-${todayISO()}.json`; a.click() };
  el('#importInput').onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ const obj=JSON.parse(await f.text()); if(!obj.members||!obj.loans||!obj.contributions) throw new Error('Invalid file'); Store=obj; saveStore(Store);  log('settings_update', { defaultContributionCents: Store.meta.defaultContributionCents, managerPinChanged: true });
flash('Backup restored'); renderAll() } catch(err){ alert('Import failed: '+err.message) } };
const pdfBtn = el('#printLogsBtn');
if (pdfBtn) pdfBtn.onclick = printLogs;

const csvC = el('#csvContrib'); if (csvC) csvC.onclick = ()=> buildContribCSV();
const csvP = el('#csvPayouts'); if (csvP) csvP.onclick = ()=> buildPayoutsCSV();


}

/***** Initial boot *****/
function renderAll(){ renderNav(); autoPlayTick(); renderOverview(); if(currentTab!=='overview') switchTab(currentTab) }
renderAll();

</script>


<script type="module">
  // ------- Firebase (ESM via Google CDN) -------
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth,
    setPersistence,
    browserLocalPersistence,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Your config
  const firebaseConfig = {
    apiKey: "AIzaSyCGkUdeWjVsd7Sw7PsNYpY3hrLKs0j3QOM",
    authDomain: "money-circle-6a59e.firebaseapp.com",
    projectId: "money-circle-6a59e",
    storageBucket: "money-circle-6a59e.appspot.com",
    messagingSenderId: "566514508721",
    appId: "1:566514508721:web:98b16bbfd5d7289af95390",
    measurementId: "G-VQ3JGVQF97"
  };

  // Init exactly once
  const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // üîí Stay signed in across reloads (the key to ‚Äúremember me‚Äù)
  await setPersistence(auth, browserLocalPersistence);

  // Expose if you want to debug in the console
  window.__fb = { app, auth, db };

  // ------- Firestore ‚Äúcloud‚Äù wiring (one doc per group) -------
  const GROUP_ID = "money-circle-001";
  const docRef   = doc(db, "groups", GROUP_ID);

  window.cloudCanWrite = false;

  async function cloudLoadOnce() {
    try {
      const snap = await getDoc(docRef);
      if (snap.exists() && snap.data()?.store) {
        window.Store = snap.data().store;
        localStorage.setItem("money-circle-vanilla-v2", JSON.stringify(window.Store));
        window.renderAll?.();
      }
    } catch (e) {
      console.warn("Cloud load failed:", e);
    }
  }

  function cloudSubscribe() {
    onSnapshot(docRef, (snap) => {
      const data = snap.data();
      if (data?.store) {
        window.Store = data.store;
        localStorage.setItem("money-circle-vanilla-v2", JSON.stringify(window.Store));
        window.renderAll?.();
      }
    }, err => console.warn("Cloud subscribe error:", err));
  }

  async function cloudSave(store) {
    if (!window.cloudCanWrite) return;           // writes only when manager is signed in
    try {
      await setDoc(docRef, { store }, { merge: true });
    } catch (e) {
      console.warn("Cloud save failed:", e);
    }
  }

  function downloadCSV(filename, headers, rows){
  const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
  const head = headers.map(esc).join(',');
  const body = rows.map(r => headers.map(h => esc(r[h])).join(',')).join('\n');
  const blob = new Blob([head+'\n'+body], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  URL.revokeObjectURL(a.href);
}

function buildContribCSV(){
  const members = Object.fromEntries(Store.members.map(m=>[m.id, m.fullName]));
  const rows = Store.contributions
    .slice().sort((a,b)=> new Date(a.date)-new Date(b.date))
    .map(c => ({
      date: c.date,
      member: members[c.memberId] || '‚Äî',
      amount: (c.amountCents||0)/100,
      note: c.note||''
    }));
  downloadCSV(`contributions-${todayISO()}.csv`, ['date','member','amount','note'], rows);
}

function buildPayoutsCSV(){
  const members = Object.fromEntries(Store.members.map(m=>[m.id, m.fullName]));
  const rows = Store.loans
    .slice().sort((a,b)=> new Date(a.date)-new Date(b.date))
    .map(l => ({
      date: l.date,
      recipient: members[l.recipientId] || '‚Äî',
      total_amount: (l.amountCents||0)/100,
      per_donor: (l.perDonorCents||0)/100,
      donors_count: (l.fromMembers||[]).length,
      donors_list: (l.fromMembers||[]).map(id=>members[id]).filter(Boolean).join('; '),
      due: l.dueDate,
      status: l.status,
      paid_at: l.paidBackAt || ''
    }));
  downloadCSV(`payouts-${todayISO()}.csv`,
    ['date','recipient','total_amount','per_donor','donors_count','donors_list','due','status','paid_at'],
    rows);
}


  // ‚úÖ ‚ÄúRemember me‚Äù: keep the email to prefill prompt (never store the password)
  const REMEMBER_EMAIL_KEY = "managerEmail";

 async function signInManager() {
  if (auth.currentUser) {
    window.cloudCanWrite = true;
    window.flash?.("Cloud: already signed in");
    return;
  }

  const savedEmail = localStorage.getItem("cloudEmail") || "";
  const email = prompt("Cloud email (Firebase Auth)", savedEmail);
  const pass  = prompt("Cloud password");
  if (!email || !pass) return;

  await setPersistence(auth, browserLocalPersistence);
  await signInWithEmailAndPassword(auth, email, pass);
  localStorage.setItem("cloudEmail", email);

  window.cloudCanWrite = true;
  window.flash?.("Cloud: manager signed in (remembered)");
  if (window.Store) await cloudSave(window.Store);
}


  async function signOutManager() {
    await signOut(auth);
    window.cloudCanWrite = false;
    window.flash?.("Cloud: signed out");
  }

  // Keep flag in sync with auth state (persistence means this will fire on reload)
  onAuthStateChanged(auth, (user) => {
    window.cloudCanWrite = !!user;
  });

  // Public API your UI can call
  window.cloud = {
    loadOnce: cloudLoadOnce,
    subscribe: cloudSubscribe,
    save: cloudSave,
    signIn: signInManager,
    signOut: signOutManager,
  };

  // Start reading immediately (reads do not require sign-in)
  window.cloud.loadOnce();
  window.cloud.subscribe();
</script>

<script>
  // Safe no-op stubs so clicks never crash if cloud/Firebase isn't wired yet
  window.cloud = window.cloud || {};
  window.cloud.signIn  = window.cloud.signIn  || (async () => alert('Cloud not ready yet.'));
  window.cloud.signOut = window.cloud.signOut || (async () => {});
  window.cloud.save    = window.cloud.save    || (async () => {});
  window.cloudCanWrite = window.cloudCanWrite || false;
</script>


</body>
</html>
